import os
import shutil

# --- CONFIG ---
ROOT_DIR = os.path.dirname(os.path.abspath(__file__))
SOURCE_FILE = os.path.join(ROOT_DIR, "src", "ResourceManager.cpp")

def patch_resource_manager():
    print(f"[FIX] Patching Path Normalization in {SOURCE_FILE}...")
    
    if not os.path.exists(SOURCE_FILE):
        print("   -> [ERROR] File not found.")
        return

    with open(SOURCE_FILE, "r", encoding="utf-8") as f:
        content = f.read()

    # 1. Patch getResourceLocation (The Lookup)
    # We rename the input argument and add normalization logic at the top
    lookup_original = "std::string ResourceManager::getResourceLocation(const std::string &resource_name) {"
    lookup_patch = """std::string ResourceManager::getResourceLocation(const std::string &resource_name_raw) {
  // [PATCH] Normalize path (lower case + forward slashes) for Windows compatibility
  std::string resource_name = Utils::string_to_lower(resource_name_raw);
  std::replace(resource_name.begin(), resource_name.end(), '\\\\', '/');
"""
    
    # 2. Patch load_resource_map (The Indexing)
    # We capture the raw file name from the zip and normalize it before storing
    index_original = "for (std::string file : ZtdFile::getFileList(current_archive)) {"
    index_patch = """for (std::string file_raw : ZtdFile::getFileList(current_archive)) {
        // [PATCH] Normalize storage key
        std::string file = Utils::string_to_lower(file_raw);
        std::replace(file.begin(), file.end(), '\\\\', '/');
"""

    new_content = content
    patches = 0

    if lookup_original in new_content:
        new_content = new_content.replace(lookup_original, lookup_patch)
        patches += 1
        print("   -> Patched Lookup Logic")
    
    if index_original in new_content:
        new_content = new_content.replace(index_original, index_patch)
        patches += 1
        print("   -> Patched Indexing Logic")

    if patches > 0:
        shutil.copy(SOURCE_FILE, SOURCE_FILE + ".bak")
        with open(SOURCE_FILE, "w", encoding="utf-8") as f:
            f.write(new_content)
        print(f"   -> Success! Applied {patches} path fixes.")
    else:
        print("   -> Warning: Code not found (or already patched).")

if __name__ == "__main__":
    patch_resource_manager()
    print("\nFix applied. Please run 'build_engine.py' to recompile.")